<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torn Ranked War Dashboard by Xerra [2775419]</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .api-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .api-input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .api-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .info-text {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }

        .info-text ul {
            list-style-type: disc;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 13px;
        }

        .warning-box strong {
            color: #856404;
        }

        .loading {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #c33;
        }

        .faction-info {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .faction-info h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .info-item label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .info-item value {
            display: block;
            font-size: 20px;
            color: #333;
            font-weight: 600;
        }

        .members-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .members-section h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .refresh-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
            font-style: italic;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filters input,
        .filters select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .filters input {
            flex: 1;
            min-width: 200px;
        }

        .members-table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
            display: block;
            font-size: 13px;
        }

        .members-table-wrapper {
            overflow-x: auto;
            width: 100%;
        }

        .members-table thead {
            background: #667eea;
            color: white;
        }

        .members-table th {
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            font-size: 12px;
        }

        .members-table th:hover {
            background: #5568d3;
        }

        .members-table th.sortable::after {
            content: ' ⇅';
            opacity: 0.5;
        }

        .members-table th.sorted-asc::after {
            content: ' ↑';
            opacity: 1;
        }

        .members-table th.sorted-desc::after {
            content: ' ↓';
            opacity: 1;
        }

        .members-table td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
        }

        .members-table tbody tr:hover {
            background: #f8f9fa;
        }

        .status-online {
            color: #28a745;
            font-weight: 600;
        }

        .status-offline {
            color: #dc3545;
            font-weight: 600;
        }

        .status-idle {
            color: #ffc107;
            font-weight: 600;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-indicator.online {
            background-color: #28a745;
        }

        .status-indicator.offline {
            background-color: #dc3545;
        }

        .status-indicator.idle {
            background-color: #ffc107;
        }

        .level-badge {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 600;
        }

        .position-badge {
            background: #764ba2;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .members-table {
                font-size: 12px;
            }

            .members-table th,
            .members-table td {
                padding: 8px;
            }
        }

        /* Tab Styles */
        .tabs-container {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #667eea;
        }

        .tab-button {
            padding: 12px 24px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            margin-right: 4px;
        }

        .tab-button:hover {
            background: #e9ecef;
            color: #333;
        }

        .tab-button.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* War Portal specific styles */
        .war-portal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .member-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .member-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .member-card.online {
            border-left-color: #28a745;
        }

        .member-card.idle {
            border-left-color: #ffc107;
        }

        .member-card.offline {
            border-left-color: #dc3545;
        }

        .member-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .member-card-name {
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }

        .member-card-name a {
            color: #667eea;
            text-decoration: none;
        }

        .member-card-name a:hover {
            text-decoration: underline;
        }

        .member-card-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 13px;
            color: #666;
        }

        .member-card-detail {
            display: flex;
            justify-content: space-between;
        }

        .member-card-detail span:first-child {
            color: #999;
        }

        .member-card-detail span:last-child {
            font-weight: 500;
            color: #333;
        }

        .war-portal-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .war-portal-filters input,
        .war-portal-filters select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .war-portal-filters input {
            flex: 1;
            min-width: 200px;
        }

        /* Hourly Activity Grid Styles */
        .activity-grid {
            display: flex;
            gap: 1px;
            margin-top: 4px;
        }

        .hour-box {
            width: 24px;
            height: 16px;
            border-radius: 2px;
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            position: relative;
        }

        .hour-box.online {
            background-color: #28a745;
        }

        .hour-box.partial {
            background-color: #ffc107;
        }

        .hour-box.offline {
            background-color: #dc3545;
        }

        .hour-box.unknown {
            background-color: #6c757d;
        }

        .hour-box:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 100;
            margin-bottom: 4px;
        }

        .member-name-cell {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .member-name-row {
            display: flex;
            align-items: center;
        }

        /* Estimated Stats Column */
        .est-stats {
            font-size: 11px;
            color: #666;
        }

        .est-stats-value {
            font-weight: 600;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Torn Ranked War Dashboard by <a href="https://www.torn.com/profiles.php?XID=2775419" target="_blank" style="color: #667eea; text-decoration: none;">Xerra [2775419]</a></h1>
            <div class="api-input-group">
                <input
                    type="text"
                    id="apiKey"
                    placeholder="Enter your Torn API Key"
                    value=""
                    onkeypress="handleEnterKey(event)">
                <input
                    type="text"
                    id="factionId"
                    placeholder="Faction ID (optional - leave empty for your faction)"
                    value=""
                    onkeypress="handleEnterKey(event)">
                <button class="btn" id="loadBtn" onclick="loadFactionData()">Load Faction Data</button>
                <button class="btn" id="findEnemyBtn" onclick="findEnemy()" style="background: #dc3545;">Find Enemy</button>
            </div>
            <div class="info-text">
                Your API key is stored locally in your browser and never sent anywhere except to Torn's official API.
                You can get your API key from: <a href="https://www.torn.com/preferences.php#tab=api" target="_blank">Torn Settings → API Key</a>
                <br><br>
                <div class="warning-box">
                    <strong>ℹ️ API Key Info:</strong><br>
                    A basic API key is sufficient to view all dashboard information. Create one at <a href="https://www.torn.com/preferences.php#tab=api" target="_blank" style="color: #856404; text-decoration: underline;">Torn Preferences → API Key</a>.
                    <br><br>
                    <strong>Note:</strong> Some stats may show as N/A if they haven't been set yet or if the player's privacy settings restrict access. Open the browser console (F12) to see detailed API response information.
                </div>
            </div>
        </div>

        <div id="content"></div>
    </div>

    <script>
        let factionData = null;
        let membersData = [];
        let sortColumn = null;
        let sortDirection = 'asc';
        let refreshInterval = null;
        let lastRefreshTime = null;

        // Activity history: stores status for each member per hour
        // Format: { memberId: { hour: { online: count, total: count } } }
        let activityHistory = {};

        // Load activity history from localStorage
        function loadActivityHistory() {
            const saved = localStorage.getItem('tornActivityHistory');
            if (saved) {
                try {
                    activityHistory = JSON.parse(saved);
                    // Clean old data (older than 24 hours)
                    cleanOldActivityData();
                } catch (e) {
                    activityHistory = {};
                }
            }
        }

        // Save activity history to localStorage
        function saveActivityHistory() {
            localStorage.setItem('tornActivityHistory', JSON.stringify(activityHistory));
        }

        // Clean data older than 24 hours
        function cleanOldActivityData() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const yesterday = new Date(now - 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            for (const memberId in activityHistory) {
                for (const hourKey in activityHistory[memberId]) {
                    if (!hourKey.startsWith(today) && !hourKey.startsWith(yesterday)) {
                        delete activityHistory[memberId][hourKey];
                    }
                }
            }
        }

        // Infer historical activity from last_action.timestamp
        // This marks the hour of their last known activity as online
        function inferHistoricalActivity(member) {
            if (!member.last_action || !member.last_action.timestamp) return;

            const lastActionTime = new Date(member.last_action.timestamp * 1000);
            const now = new Date();
            const hoursDiff = Math.floor((now - lastActionTime) / (60 * 60 * 1000));

            // Only infer for last 24 hours
            if (hoursDiff > 24) return;

            if (!activityHistory[member.id]) {
                activityHistory[member.id] = {};
            }

            // Mark the hour of last activity as online (if we don't already have data for it)
            const lastActionHourKey = lastActionTime.toISOString().split('T')[0] + '-' + lastActionTime.getHours().toString().padStart(2, '0');

            if (!activityHistory[member.id][lastActionHourKey]) {
                activityHistory[member.id][lastActionHourKey] = { online: 1, idle: 0, total: 1 };
            }

            // If they were active recently (within last hour), they were likely online for recent hours too
            // Mark hours between last action and now as partially known
            if (hoursDiff <= 1 && (member.last_action.status === 'Online' || member.last_action.status === 'Idle')) {
                const currentHourKey = now.toISOString().split('T')[0] + '-' + now.getHours().toString().padStart(2, '0');
                if (!activityHistory[member.id][currentHourKey]) {
                    if (member.last_action.status === 'Online') {
                        activityHistory[member.id][currentHourKey] = { online: 1, idle: 0, total: 1 };
                    } else {
                        activityHistory[member.id][currentHourKey] = { online: 0, idle: 1, total: 1 };
                    }
                }
            }
        }

        // Record current status for all members
        function recordActivityStatus() {
            const now = new Date();
            const hourKey = now.toISOString().split('T')[0] + '-' + now.getHours().toString().padStart(2, '0');

            membersData.forEach(member => {
                // First, infer any historical data from their last_action timestamp
                inferHistoricalActivity(member);

                if (!activityHistory[member.id]) {
                    activityHistory[member.id] = {};
                }
                if (!activityHistory[member.id][hourKey]) {
                    activityHistory[member.id][hourKey] = { online: 0, idle: 0, total: 0 };
                }

                activityHistory[member.id][hourKey].total++;
                if (member.last_action.status === 'Online') {
                    activityHistory[member.id][hourKey].online++;
                } else if (member.last_action.status === 'Idle') {
                    activityHistory[member.id][hourKey].idle++;
                }
            });

            saveActivityHistory();
        }

        // Get activity status for an hour (returns 'online', 'partial', 'offline', or 'unknown')
        function getHourStatus(memberId, hourKey) {
            if (!activityHistory[memberId] || !activityHistory[memberId][hourKey]) {
                return 'unknown';
            }

            const data = activityHistory[memberId][hourKey];
            if (data.total === 0) return 'unknown';

            const onlineRatio = (data.online + data.idle * 0.5) / data.total;

            if (onlineRatio >= 0.8) return 'online';
            if (onlineRatio >= 0.2) return 'partial';
            return 'offline';
        }

        // Generate 24-hour activity grid HTML
        function generateActivityGrid(memberId) {
            const now = new Date();
            const hours = [];

            // Generate last 24 hours
            for (let i = 23; i >= 0; i--) {
                const hourDate = new Date(now - i * 60 * 60 * 1000);
                const hourKey = hourDate.toISOString().split('T')[0] + '-' + hourDate.getHours().toString().padStart(2, '0');
                const hourLabel = hourDate.getHours().toString().padStart(2, '0') + ':00';
                const status = getHourStatus(memberId, hourKey);

                hours.push(`<div class="hour-box ${status}" data-tooltip="${hourLabel}" title="${hourLabel}">${hourDate.getHours()}</div>`);
            }

            return `<div class="activity-grid">${hours.join('')}</div>`;
        }

        // Estimate battle stats based on publicly available data
        // Formula based on community research: xanax is a strong indicator
        // ~1 billion total stats per 1000 xanax for established players
        function estimateBattleStats(member) {
            const stats = member.details.personalstats || {};
            const profile = member.details || {};

            const level = member.level || 1;
            const age = profile.age || 1;
            const xanax = stats.xantaken || 0;
            const refills = stats.energydrinkused || stats.refills || 0;
            const attacks = (stats.attackswon || 0) + (stats.attackslost || 0);

            // Base estimation using multiple factors
            let estimate = 0;

            // Primary factor: Xanax (most reliable indicator)
            // ~1 billion stats per 1000 xanax for active trainers
            if (xanax > 0) {
                estimate = xanax * 1000000; // 1M per xanax as baseline
            }

            // Secondary factors for adjustment
            const levelFactor = 1 + (level / 100); // Level adds up to ~2x multiplier at level 100
            const ageFactor = 1 + Math.min(age / 3650, 1); // Age adds up to 2x over 10 years

            // If no xanax data, use level/age based estimation
            if (estimate === 0) {
                const baseStat = 1500000;
                estimate = baseStat * levelFactor * ageFactor;
            } else {
                // Apply modifiers
                estimate = estimate * (levelFactor * 0.3 + 0.7) * (ageFactor * 0.3 + 0.7);
            }

            // Refills boost (energy refills indicate active player)
            if (refills > 0) {
                estimate *= 1 + Math.min(refills / 5000, 0.5);
            }

            return {
                low: Math.round(estimate * 0.7),
                mid: Math.round(estimate),
                high: Math.round(estimate * 1.3)
            };
        }

        // Format large numbers
        function formatStatNumber(num) {
            if (num >= 1e12) return (num / 1e12).toFixed(1) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
            return num.toString();
        }

        // Handle Enter key press on input fields
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                loadFactionData();
            }
        }

        // Find and load enemy faction from current ranked war
        async function findEnemy() {
            const apiKey = document.getElementById('apiKey').value.trim();

            if (!apiKey) {
                showError('Please enter your API key first');
                return;
            }

            showLoading();

            try {
                // First, get the user's faction ID
                const userResponse = await fetch(`https://api.torn.com/user?selections=basic&key=${apiKey}`);
                const userData = await userResponse.json();

                if (userData.error) {
                    throw new Error(userData.error.error);
                }

                const myFactionId = userData.faction.faction_id;

                if (!myFactionId) {
                    throw new Error('You are not in a faction');
                }

                // Get faction's ranked war info
                const factionResponse = await fetch(`https://api.torn.com/faction/${myFactionId}?selections=rankedwars&key=${apiKey}`);
                const factionData = await factionResponse.json();

                if (factionData.error) {
                    throw new Error(factionData.error.error);
                }

                console.log('Ranked wars data:', factionData);

                // Find active ranked war
                const rankedWars = factionData.rankedwars || {};
                let enemyFactionId = null;

                for (const warId in rankedWars) {
                    const war = rankedWars[warId];
                    // Check if war is active (has factions but no winner yet or is ongoing)
                    if (war.factions) {
                        for (const factionId in war.factions) {
                            if (factionId != myFactionId) {
                                enemyFactionId = factionId;
                                break;
                            }
                        }
                    }
                    if (enemyFactionId) break;
                }

                if (!enemyFactionId) {
                    throw new Error('You are not currently matched for a Ranked War against another faction!');
                }

                // Load the enemy faction
                document.getElementById('factionId').value = enemyFactionId;
                localStorage.setItem('tornFactionId', enemyFactionId);
                loadFactionData();

            } catch (error) {
                console.error('Error finding enemy:', error);
                showError(`Error finding enemy faction: ${error.message}`);
            }
        }

        // Load saved API key and faction ID from localStorage
        window.addEventListener('DOMContentLoaded', () => {
            loadActivityHistory();

            const savedKey = localStorage.getItem('tornApiKey');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
            }

            const savedFactionId = localStorage.getItem('tornFactionId');
            if (savedFactionId) {
                document.getElementById('factionId').value = savedFactionId;
            }

            // Auto-load faction data if API key is saved
            if (savedKey) {
                loadFactionData();
            }
        });

        async function loadFactionData() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const factionId = document.getElementById('factionId').value.trim() || '';

            if (!apiKey) {
                showError('Please enter your API key');
                return;
            }

            // Save API key to localStorage
            localStorage.setItem('tornApiKey', apiKey);

            // Save faction ID to localStorage (if provided)
            if (factionId) {
                localStorage.setItem('tornFactionId', factionId);
            }

            showLoading();

            try {
                // Load faction basic info and members
                // Note: Using API without /v2 for better compatibility
                const factionUrl = factionId
                    ? `https://api.torn.com/faction/${factionId}?selections=basic&key=${apiKey}`
                    : `https://api.torn.com/faction?selections=basic&key=${apiKey}`;

                const response = await fetch(factionUrl);
                const data = await response.json();

                console.log('Faction data response:', data);

                if (data.error) {
                    throw new Error(data.error.error);
                }

                factionData = data;

                // If faction ID was blank, store the loaded faction's ID for future use
                if (!factionId && data.ID) {
                    localStorage.setItem('tornFactionId', data.ID.toString());
                    document.getElementById('factionId').value = data.ID;
                }

                // Extract member IDs from the faction data which includes members in basic
                const memberIds = data.members ? Object.keys(data.members) : [];
                console.log('Fetching details for', memberIds.length, 'members');

                const memberDetailsPromises = memberIds.map(id =>
                    fetch(`https://api.torn.com/user/${id}?selections=profile,personalstats&key=${apiKey}`)
                        .then(r => r.json())
                        .then(d => {
                            console.log(`Member ${id} data:`, d);
                            if (d.error) {
                                console.warn(`API returned error for member ${id}:`, d.error);
                            }
                            return { ...d, member_id: id };
                        })
                        .catch(e => {
                            console.error(`Error fetching member ${id}:`, e);
                            return { member_id: id, error: e.message };
                        })
                );

                const memberDetails = await Promise.all(memberDetailsPromises);

                membersData = Object.entries(data.members || {}).map(([id, member]) => {
                    const details = memberDetails.find(d => d.member_id == id || d.player_id == id);

                    // Check if the details have an error
                    if (details && details.error) {
                        console.warn(`Member ${id} details have error:`, details.error);
                    }

                    return {
                        id,
                        ...member,
                        details: details || {}
                    };
                });

                // Check if any member details failed to load
                const failedMembers = memberDetails.filter(d => d.error);
                if (failedMembers.length > 0) {
                    console.warn(`Failed to load details for ${failedMembers.length} members. This may be due to API key permissions.`);
                }

                lastRefreshTime = new Date();
                recordActivityStatus(); // Record activity for tracking
                renderDashboard();
                startAutoRefresh();
            } catch (error) {
                console.error('Error details:', error);
                showError(`Error loading faction data: ${error.message}<br><br>Check browser console (F12) for more details.`);
            }
        }

        function startAutoRefresh() {
            // Clear any existing interval
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }

            // Refresh every 60 seconds (Torn API allows this rate)
            refreshInterval = setInterval(async () => {
                const apiKey = document.getElementById('apiKey').value.trim();
                const factionId = document.getElementById('factionId').value.trim() || '';

                if (!apiKey) return;

                try {
                    const factionUrl = factionId
                        ? `https://api.torn.com/faction/${factionId}?selections=basic&key=${apiKey}`
                        : `https://api.torn.com/faction?selections=basic&key=${apiKey}`;

                    const response = await fetch(factionUrl);
                    const data = await response.json();

                    if (data.error) {
                        console.error('Auto-refresh error:', data.error);
                        return;
                    }

                    factionData = data;

                    // Fetch detailed stats for each member
                    const memberIds = Object.keys(data.members || {});
                    const memberDetailsPromises = memberIds.map(id =>
                        fetch(`https://api.torn.com/user/${id}?selections=profile,personalstats&key=${apiKey}`)
                            .then(r => r.json())
                            .then(d => ({ ...d, member_id: id }))
                            .catch(e => ({ member_id: id, error: e.message }))
                    );

                    const memberDetails = await Promise.all(memberDetailsPromises);

                    membersData = Object.entries(data.members || {}).map(([id, member]) => {
                        const details = memberDetails.find(d => d.member_id == id || d.player_id == id);
                        return {
                            id,
                            ...member,
                            details: details || {}
                        };
                    });

                    lastRefreshTime = new Date();
                    recordActivityStatus(); // Record activity for tracking

                    // Update only the refresh time and re-apply filters
                    const refreshTimeElement = document.getElementById('lastRefreshTime');
                    if (refreshTimeElement) {
                        refreshTimeElement.textContent = formatTime(lastRefreshTime);
                    }
                    filterMembers();
                } catch (error) {
                    console.error('Auto-refresh error:', error);
                }
            }, 60000); // 60 seconds
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        function showLoading() {
            document.getElementById('content').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading faction data...</p>
                </div>
            `;
        }

        function showError(message) {
            document.getElementById('content').innerHTML = `
                <div class="error">
                    <strong>Error:</strong> ${message}
                </div>
            `;
        }

        function renderDashboard() {
            const content = document.getElementById('content');

            const onlineCount = membersData.filter(m => m.last_action.status === 'Online').length;
            const idleCount = membersData.filter(m => m.last_action.status === 'Idle').length;
            const offlineCount = membersData.filter(m => m.last_action.status === 'Offline').length;
            const totalLevel = membersData.reduce((sum, m) => sum + (m.level || 0), 0);
            const avgLevel = Math.round(totalLevel / membersData.length);

            content.innerHTML = `
                <div class="faction-info">
                    <h2>${factionData.name || 'Faction Information'}</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Faction ID</label>
                            <value>${factionData.ID || 'N/A'}</value>
                        </div>
                        <div class="info-item">
                            <label>Members</label>
                            <value>${membersData.length}</value>
                        </div>
                        <div class="info-item">
                            <label>Respect</label>
                            <value>${(factionData.respect || 0).toLocaleString()}</value>
                        </div>
                        <div class="info-item">
                            <label>Age</label>
                            <value>${factionData.age || 'N/A'} days</value>
                        </div>
                        <div class="info-item">
                            <label>Capacity</label>
                            <value>${factionData.capacity || 'N/A'}</value>
                        </div>
                        <div class="info-item">
                            <label>Leader</label>
                            <value>${factionData.leader ? `<a href="https://www.torn.com/profiles.php?XID=${factionData.leader}" target="_blank" style="color: #667eea; text-decoration: none;">${getLeaderName()}</a>` : 'N/A'}</value>
                        </div>
                    </div>
                </div>

                <div class="members-section">
                    <h2>Members Overview</h2>
                    <div class="refresh-info">Auto-refreshing every 60 seconds. Last updated: <span id="lastRefreshTime">${formatTime(lastRefreshTime)}</span></div>

                    <div class="stats-summary">
                        <div class="stat-card">
                            <h3>Online</h3>
                            <div class="value">${onlineCount}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Idle</h3>
                            <div class="value">${idleCount}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Offline</h3>
                            <div class="value">${offlineCount}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Average Level</h3>
                            <div class="value">${avgLevel}</div>
                        </div>
                    </div>

                    <div class="tabs-container">
                        <div class="tab-buttons">
                            <button class="tab-button active" onclick="switchTab('war-planning')">War Planning</button>
                            <button class="tab-button" onclick="switchTab('war-portal')">War Portal</button>
                        </div>

                        <div id="war-planning" class="tab-content active">
                            <div class="filters">
                                <input type="text" id="searchInput" placeholder="Search members..." onkeyup="filterMembers()">
                                <select id="statusFilter" onchange="filterMembers()">
                                    <option value="">All Status</option>
                                    <option value="Online">Online</option>
                                    <option value="Idle">Idle</option>
                                    <option value="Offline">Offline</option>
                                </select>
                                <select id="locationFilter" onchange="filterMembers()">
                                    <option value="">All Locations</option>
                                    ${getUniqueLocations().map(loc => `<option value="${loc.toLowerCase()}">${loc}</option>`).join('')}
                                </select>
                                <select id="positionFilter" onchange="filterMembers()">
                                    <option value="">All Positions</option>
                                    ${getUniquePositions().map(pos => `<option value="${pos}">${pos}</option>`).join('')}
                                </select>
                            </div>
                            <div id="membersTableContainer"></div>
                        </div>

                        <div id="war-portal" class="tab-content">
                            <div class="war-portal-filters">
                                <input type="text" id="portalSearchInput" placeholder="Search members..." onkeyup="filterPortalMembers()">
                                <select id="portalStatusFilter" onchange="filterPortalMembers()">
                                    <option value="">All Status</option>
                                    <option value="Online">Online</option>
                                    <option value="Idle">Idle</option>
                                    <option value="Offline">Offline</option>
                                </select>
                            </div>
                            <div id="warPortalContainer"></div>
                        </div>
                    </div>
                </div>
            `;

            renderMembersTable(membersData);
            renderWarPortal(membersData);
        }

        function getUniquePositions() {
            const positions = new Set(membersData.map(m => m.position));
            return Array.from(positions).sort();
        }

        function getUniqueLocations() {
            const locations = new Set();
            membersData.forEach(m => {
                const userStatus = (m.details && m.details.status) || {};
                let locationText = (userStatus.description || userStatus.state || 'Unknown').trim();

                if (locationText && locationText !== 'Unknown') {
                    // Normalize hospital statuses to just "In Hospital"
                    if (locationText.toLowerCase().includes('hospital')) {
                        locationText = 'In Hospital';
                    }
                    // Normalize jail statuses to just "In Jail"
                    else if (locationText.toLowerCase().includes('jail')) {
                        locationText = 'In Jail';
                    }
                    // Normalize traveling statuses
                    else if (locationText.toLowerCase().includes('traveling') || locationText.toLowerCase().includes('flying')) {
                        locationText = 'Traveling';
                    }

                    locations.add(locationText);
                }
            });
            return Array.from(locations).sort();
        }

        function filterMembers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const locationFilter = document.getElementById('locationFilter').value.toLowerCase();
            const positionFilter = document.getElementById('positionFilter').value;

            let filtered = membersData.filter(member => {
                const matchesSearch = member.name.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || member.last_action.status === statusFilter;

                // Check location filter using the status from details
                let matchesLocation = true;
                if (locationFilter) {
                    const userStatus = (member.details && member.details.status) || {};
                    const locationText = (userStatus.description || userStatus.state || '').toLowerCase();
                    matchesLocation = locationText.includes(locationFilter);
                }

                const matchesPosition = !positionFilter || member.position === positionFilter;
                return matchesSearch && matchesStatus && matchesLocation && matchesPosition;
            });

            renderMembersTable(filtered);
        }

        function sortMembers(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const locationFilter = document.getElementById('locationFilter').value.toLowerCase();
            const positionFilter = document.getElementById('positionFilter').value;

            let filtered = membersData.filter(member => {
                const matchesSearch = member.name.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || member.last_action.status === statusFilter;

                // Check location filter using the status from details
                let matchesLocation = true;
                if (locationFilter) {
                    const userStatus = (member.details && member.details.status) || {};
                    const locationText = (userStatus.description || userStatus.state || '').toLowerCase();
                    matchesLocation = locationText.includes(locationFilter);
                }

                const matchesPosition = !positionFilter || member.position === positionFilter;
                return matchesSearch && matchesStatus && matchesLocation && matchesPosition;
            });

            filtered.sort((a, b) => {
                let aVal, bVal;

                switch(column) {
                    case 'name':
                        aVal = a.name.toLowerCase();
                        bVal = b.name.toLowerCase();
                        break;
                    case 'est_stats':
                        aVal = estimateBattleStats(a).mid;
                        bVal = estimateBattleStats(b).mid;
                        break;
                    case 'level':
                        aVal = a.level || 0;
                        bVal = b.level || 0;
                        break;
                    case 'age':
                        aVal = (a.details && a.details.age) || 0;
                        bVal = (b.details && b.details.age) || 0;
                        break;
                    case 'life':
                        aVal = (a.details && a.details.life && a.details.life.current) || 0;
                        bVal = (b.details && b.details.life && b.details.life.current) || 0;
                        break;
                    case 'elo':
                        aVal = (a.details && a.details.personalstats && (a.details.personalstats.elo || a.details.personalstats.rankedwarrating)) || 0;
                        bVal = (b.details && b.details.personalstats && (b.details.personalstats.elo || b.details.personalstats.rankedwarrating)) || 0;
                        break;
                    case 'best_damage':
                        aVal = (a.details && a.details.personalstats && (a.details.personalstats.bestdamage || a.details.personalstats.highestbeaten)) || 0;
                        bVal = (b.details && b.details.personalstats && (b.details.personalstats.bestdamage || b.details.personalstats.highestbeaten)) || 0;
                        break;
                    case 'critical_hits':
                        const aCrit = (a.details && a.details.personalstats && a.details.personalstats.attackcriticalhits) || 0;
                        const aTotal = (a.details && a.details.personalstats && a.details.personalstats.attackhits) || 1;
                        const bCrit = (b.details && b.details.personalstats && b.details.personalstats.attackcriticalhits) || 0;
                        const bTotal = (b.details && b.details.personalstats && b.details.personalstats.attackhits) || 1;
                        aVal = aCrit / aTotal;
                        bVal = bCrit / bTotal;
                        break;
                    case 'rw_hits':
                        aVal = (a.details && a.details.personalstats && a.details.personalstats.rankedwarhits) || 0;
                        bVal = (b.details && b.details.personalstats && b.details.personalstats.rankedwarhits) || 0;
                        break;
                    case 'xanax':
                        aVal = (a.details && a.details.personalstats && a.details.personalstats.xantaken) || 0;
                        bVal = (b.details && b.details.personalstats && b.details.personalstats.xantaken) || 0;
                        break;
                    case 'vicodin':
                        aVal = (a.details && a.details.personalstats && a.details.personalstats.victaken) || 0;
                        bVal = (b.details && b.details.personalstats && b.details.personalstats.victaken) || 0;
                        break;
                    case 'overdosed':
                        aVal = (a.details && a.details.personalstats && a.details.personalstats.overdosed) || 0;
                        bVal = (b.details && b.details.personalstats && b.details.personalstats.overdosed) || 0;
                        break;
                    case 'refills':
                        aVal = (a.details && a.details.personalstats && (a.details.personalstats.energydrinkused || a.details.personalstats.refills)) || 0;
                        bVal = (b.details && b.details.personalstats && (b.details.personalstats.energydrinkused || b.details.personalstats.refills)) || 0;
                        break;
                    case 'location':
                        const aStatus = (a.details && a.details.status) || {};
                        const bStatus = (b.details && b.details.status) || {};
                        aVal = (aStatus.description || aStatus.state || 'Unknown').toLowerCase();
                        bVal = (bStatus.description || bStatus.state || 'Unknown').toLowerCase();
                        break;
                    case 'status':
                        aVal = a.last_action.status;
                        bVal = b.last_action.status;
                        break;
                    case 'position':
                        aVal = a.position;
                        bVal = b.position;
                        break;
                    default:
                        return 0;
                }

                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            renderMembersTable(filtered);
        }

        function renderMembersTable(members) {
            const container = document.getElementById('membersTableContainer');

            const getSortClass = (column) => {
                if (sortColumn !== column) return 'sortable';
                return sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc';
            };

            container.innerHTML = `
                <table class="members-table">
                    <thead>
                        <tr>
                            <th class="${getSortClass('name')}" onclick="sortMembers('name')">Name / 24h Activity</th>
                            <th class="${getSortClass('est_stats')}" onclick="sortMembers('est_stats')">Est. Stats</th>
                            <th class="${getSortClass('level')}" onclick="sortMembers('level')">Level</th>
                            <th class="${getSortClass('age')}" onclick="sortMembers('age')">Age (days)</th>
                            <th class="${getSortClass('life')}" onclick="sortMembers('life')">Life</th>
                            <th class="${getSortClass('elo')}" onclick="sortMembers('elo')">ELO</th>
                            <th class="${getSortClass('best_damage')}" onclick="sortMembers('best_damage')">Best DMG</th>
                            <th class="${getSortClass('critical_hits')}" onclick="sortMembers('critical_hits')">Crit %</th>
                            <th class="${getSortClass('rw_hits')}" onclick="sortMembers('rw_hits')">RW Hits</th>
                            <th class="${getSortClass('xanax')}" onclick="sortMembers('xanax')">Xanax</th>
                            <th class="${getSortClass('vicodin')}" onclick="sortMembers('vicodin')">Vicodin</th>
                            <th class="${getSortClass('overdosed')}" onclick="sortMembers('overdosed')">OD</th>
                            <th class="${getSortClass('refills')}" onclick="sortMembers('refills')">Refills</th>
                            <th class="${getSortClass('location')}" onclick="sortMembers('location')">Location</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${members.map(member => {
                            const statusClass = member.last_action.status === 'Online' ? 'status-online' :
                                              member.last_action.status === 'Idle' ? 'status-idle' : 'status-offline';

                            const stats = member.details.personalstats || {};
                            const profile = member.details || member;

                            const age = profile.age || 'N/A';
                            const life = profile.life ? `${profile.life.current}/${profile.life.maximum}` : 'N/A';
                            const elo = stats.elo || stats.rankedwarrating || 'N/A';
                            const bestDamage = stats.bestdamage || stats.highestbeaten || 'N/A';

                            const criticalHits = stats.attackcriticalhits || 0;
                            const totalHits = stats.attackhits || 0;
                            const criticalPct = totalHits > 0 ? ((criticalHits / totalHits) * 100).toFixed(2) : '0.00';

                            const rwHits = stats.rankedwarhits || 'N/A';
                            const xanax = stats.xantaken || 'N/A';
                            const vicodin = stats.victaken || 'N/A';
                            const overdosed = stats.overdosed || 'N/A';
                            const refills = stats.energydrinkused || stats.refills || 'N/A';

                            // Get location/status information
                            const userStatus = profile.status || {};
                            let locationText = 'Unknown';
                            let locationClass = '';

                            if (userStatus.description) {
                                locationText = userStatus.description;
                            } else if (userStatus.state) {
                                locationText = userStatus.state;
                            }

                            // Format travel status to be shorter
                            const flyingToMatch = locationText.match(/Flying to (.+)/i);
                            const returningMatch = locationText.match(/Returning to (.+)/i);
                            const travelingToMatch = locationText.match(/Traveling to (.+)/i);
                            const inCountryMatch = locationText.match(/In (.+)/i);

                            if (flyingToMatch) {
                                locationText = 'Outbound: ' + flyingToMatch[1];
                            } else if (travelingToMatch) {
                                locationText = 'Outbound: ' + travelingToMatch[1];
                            } else if (returningMatch) {
                                locationText = 'Inbound: ' + returningMatch[1];
                            } else if (inCountryMatch && !locationText.toLowerCase().includes('hospital') && !locationText.toLowerCase().includes('jail')) {
                                // They're abroad in a country
                                locationText = 'Abroad: ' + inCountryMatch[1];
                            }

                            // Add color coding for different states
                            if (locationText.toLowerCase().includes('okay') || locationText.toLowerCase().includes('torn')) {
                                locationClass = 'status-online';
                            } else if (locationText.toLowerCase().includes('hospital') || locationText.toLowerCase().includes('jail')) {
                                locationClass = 'status-offline';
                            } else if (locationText.toLowerCase().includes('outbound') || locationText.toLowerCase().includes('inbound') || locationText.toLowerCase().includes('abroad')) {
                                locationClass = 'status-idle';
                            }

                            // Determine status indicator class
                            let statusIndicatorClass = 'offline';
                            if (member.last_action.status === 'Online') {
                                statusIndicatorClass = 'online';
                            } else if (member.last_action.status === 'Idle') {
                                statusIndicatorClass = 'idle';
                            }

                            // Calculate estimated stats
                            const estStats = estimateBattleStats(member);

                            return `
                                <tr>
                                    <td>
                                        <div class="member-name-cell">
                                            <div class="member-name-row">
                                                <span class="status-indicator ${statusIndicatorClass}"></span>
                                                <a href="https://www.torn.com/profiles.php?XID=${member.id}" target="_blank">
                                                    ${member.name}
                                                </a>
                                            </div>
                                            ${generateActivityGrid(member.id)}
                                        </div>
                                    </td>
                                    <td class="est-stats">
                                        <span class="est-stats-value">${formatStatNumber(estStats.mid)}</span>
                                        <br><span style="font-size:10px;color:#999;">${formatStatNumber(estStats.low)} - ${formatStatNumber(estStats.high)}</span>
                                    </td>
                                    <td><span class="level-badge">${member.level || 'N/A'}</span></td>
                                    <td>${age}</td>
                                    <td>${life}</td>
                                    <td>${elo}</td>
                                    <td>${typeof bestDamage === 'number' ? bestDamage.toLocaleString() : bestDamage}</td>
                                    <td>${criticalPct}%</td>
                                    <td>${typeof rwHits === 'number' ? rwHits.toLocaleString() : rwHits}</td>
                                    <td>${typeof xanax === 'number' ? xanax.toLocaleString() : xanax}</td>
                                    <td>${typeof vicodin === 'number' ? vicodin.toLocaleString() : vicodin}</td>
                                    <td>${typeof overdosed === 'number' ? overdosed.toLocaleString() : overdosed}</td>
                                    <td>${typeof refills === 'number' ? refills.toLocaleString() : refills}</td>
                                    <td class="${locationClass}">${locationText}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function formatLastAction(relative) {
            return relative || 'Unknown';
        }

        function formatTime(date) {
            if (!date) return 'Never';
            return date.toLocaleTimeString();
        }

        function getLeaderName() {
            if (!factionData || !factionData.leader) return 'N/A';
            // Look up leader name from members data
            if (factionData.members && factionData.members[factionData.leader]) {
                return factionData.members[factionData.leader].name;
            }
            // Fallback: check membersData array
            const leaderMember = membersData.find(m => m.id == factionData.leader);
            if (leaderMember) {
                return leaderMember.name;
            }
            return 'N/A';
        }

        function switchTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
        }

        function renderWarPortal(members) {
            const container = document.getElementById('warPortalContainer');
            if (!container) return;

            container.innerHTML = `
                <div class="war-portal-grid">
                    ${members.map(member => {
                        const statusClass = member.last_action.status === 'Online' ? 'online' :
                                          member.last_action.status === 'Idle' ? 'idle' : 'offline';

                        const stats = member.details.personalstats || {};
                        const profile = member.details || member;

                        const life = profile.life ? `${profile.life.current}/${profile.life.maximum}` : 'N/A';
                        const userStatus = profile.status || {};
                        let locationText = userStatus.description || userStatus.state || 'Unknown';

                        return `
                            <div class="member-card ${statusClass}">
                                <div class="member-card-header">
                                    <div class="member-card-name">
                                        <span class="status-indicator ${statusClass}"></span>
                                        <a href="https://www.torn.com/profiles.php?XID=${member.id}" target="_blank">${member.name}</a>
                                    </div>
                                    <span class="level-badge">Lv ${member.level || 'N/A'}</span>
                                </div>
                                <div class="member-card-details">
                                    <div class="member-card-detail">
                                        <span>Position</span>
                                        <span>${member.position || 'N/A'}</span>
                                    </div>
                                    <div class="member-card-detail">
                                        <span>Life</span>
                                        <span>${life}</span>
                                    </div>
                                    <div class="member-card-detail">
                                        <span>Status</span>
                                        <span>${member.last_action.status}</span>
                                    </div>
                                    <div class="member-card-detail">
                                        <span>Location</span>
                                        <span>${locationText}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function filterPortalMembers() {
            const searchTerm = document.getElementById('portalSearchInput').value.toLowerCase();
            const statusFilter = document.getElementById('portalStatusFilter').value;

            let filtered = membersData.filter(member => {
                const matchesSearch = member.name.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || member.last_action.status === statusFilter;
                return matchesSearch && matchesStatus;
            });

            renderWarPortal(filtered);
        }
    </script>
</body>
</html>
